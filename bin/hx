#!/usr/bin/env node

'use strict';

var low = require('../src/lowercase.js');

var fs = require('fs');
var path = require('path');
var exec = require('child_process').exec;
var os = require('os');

var options = {};


var help = function () {
};



var base;
var value;
var userConfig;
var isWatch = true;
var isEditConfig = false;
var args = process.argv.slice(2);


if (args[0] && /^[^-]|\//.test(args[0])) {
    base = args.shift();
}


while (args.length > 0) {
    value = args.shift();
    switch (value) {

        // 监控修改
        case '-ex':
        	var myfile="test/data/sample.txt"
			low.lowerCase(myfile);
			break;

        default:

            if (!base) {
                base = value;
            }
    }
}


if (!base) {
    base = './';
}


if (!fs.existsSync(base)) {
    process.stdout.write('Error: directory does not exist\n');
    process.exit(1);
}


var tmodjs = new TmodJS(base, options);


tmodjs.on('compileError', function (data) {
    if (!isWatch) {
        process.exit(1);
    }
});


userConfig = tmodjs.saveConfig();


if (isEditConfig) {
    
    process.stdout.write('Open: ' + userConfig + '\n');

    exec(
        (/windows/i.test(os.type()) ? 'start' : 'open')
        + ' ' + userConfig, {timeout: 0}, function () {}
    );


} else {

    tmodjs.compile();

    if (isWatch) {
        tmodjs.watch();
    }
    
}
